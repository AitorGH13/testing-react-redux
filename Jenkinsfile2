pipeline {
    agent any
    environment {
        TIMESTAMP = new Date().format("yyyyMMdd_HHmmss")
    }
    stages {
        stage('Versiones') {
            steps {
                script {
                    def timestamp = new Date().format("yyyyMMdd_HHmmss")
                    def filename = "versiones_${timestamp}.txt"

                    withCredentials([
                        usernamePassword(
                            credentialsId: '1',
                            usernameVariable: 'JENKINS_USER',
                            passwordVariable: 'JENKINS_TOKEN'
                        )
                    ]) {
                        sh """
                            echo "Java Version:" > ${filename}
                            java -version 2>> ${filename}
                            echo "\\nJenkins Version:" >> ${filename}
                            curl -u "$JENKINS_USER:$JENKINS_TOKEN" -s http://localhost:8081/api/json?pretty=true | grep version >> ${filename} || true
                        """
                    }

                    // Guardar como artefacto descargable
                    archiveArtifacts artifacts: filename, fingerprint: true
                }
            }
        }
        stage('Escaneo de Puertos') {
            steps {
                script {
                    def file = "puertos_${TIMESTAMP}.txt"
                    def ip = sh(script: "hostname -I | awk '{print \$1}'", returnStdout: true).trim()
                    sh """
                        echo "Puertos abiertos en la IP ${ip}:" > ${filename}
                        ss -tuln | grep ${ip} >> ${filename}
                    """
                }
            }
        }
    }
}


