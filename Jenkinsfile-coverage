pipeline {
  agent any

  // Usa la instalación que acabas de crear
  tools {
    nodejs 'Node14'
  }

  triggers {
    // Si quieres diario: 
    cron('H 2 * * *')
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Install Dependencies') {
      steps {
        // npm ya está en PATH
        sh 'npm install'
      }
    }

    stage('Run Tests & Collect Coverage') {
      steps {
        // Asume que en package.json tienes: "test:coverage": "jest --coverage --coverageReporters=lcov"
        sh 'npm run test:coverage'
      }
    }

    stage('Publish Coverage Report') {
      steps {
        // Publica el informe LCOV generado por Jest
        publishHTML([
          reportDir: 'coverage/lcov-report',
          reportFiles: 'index.html',
          reportName: 'Jest Coverage',
          keepAll: true
        ])
        // Opcional: extraer porcentaje de cobertura global
        script {
          def summary = readFile 'coverage/coverage-summary.json'
          def json    = readJSON text: summary
          def pct     = json.total.lines.pct
          echo "==> Coverage total de líneas: ${pct}%"
        }
      }
    }
  }

  post {
    always {
      // Archiva artefactos para histórico
      archiveArtifacts artifacts: 'coverage/**', fingerprint: true
      // No habrá reports JUnit salvo que uses un transformador de Jest a JUnit
    }
  }
}

