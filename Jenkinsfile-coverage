pipeline {
  agent {
    docker {
      image 'maven:3.8.5-openjdk-11'
      args  '-v /root/.m2:/root/.m2'  // cache local de repositorios
    }
  }

  triggers {
    cron('30 2 * * *')
  }

  stages {
    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Build & Test') {
      steps {
        // mvn ya existe dentro del contenedor
        sh 'mvn clean test jacoco:report'
      }
    }

    stage('Publish Coverage') {
      steps {
        publishHTML([
          reportDir: 'target/site/jacoco',
          reportFiles: 'index.html',
          reportName: 'JaCoCo Coverage',
          keepAll: true
        ])
        script {
          def xml = readFile 'target/site/jacoco/jacoco.xml'
          def m = xml =~ /<counter type="INSTRUCTION" missed="(\d+)" covered="(\d+)"\/>/
          if (m) {
            def missed = m[0][1].toInteger()
            def covered = m[0][2].toInteger()
            def pct = (covered / (missed + covered) * 100).round(2)
            echo "==> Coverage (instructions): ${pct}%"
          } else {
            error "No se pudo extraer coverage de jacoco.xml"
          }
        }
      }
    }
  }

  post {
    always {
      junit 'target/surefire-reports/*.xml'
      archiveArtifacts artifacts: 'target/site/jacoco/**', fingerprint: true
    }
  }
}

