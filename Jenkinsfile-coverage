pipeline {
  agent any

  tools {
    nodejs 'Node14'   // asegúrate de tener configurado NodeJS con ese nombre
  }

  triggers {
    cron('30 2 * * *')
  }

  stages {
    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Install Dependencies') {
      steps {
        sh 'npm install'
      }
    }

    stage('Run Tests & Collect Coverage') {
      steps {
        // Lanza Jest con cobertura y en modo no-watch
        sh 'npm run test -- --coverage --watchAll=false'
      }
    }

    stage('Publish Coverage Report') {
      steps {
        publishHTML([
          reportDir   : 'coverage/lcov-report',
          reportFiles : 'index.html',
          reportName  : 'Jest Coverage',
          keepAll     : true
        ])
        script {
          // Opcional: extraer % líneas cubiertas del summary JSON
          def summary = readFile 'coverage/coverage-summary.json'
          def json    = readJSON text: summary
          def pct     = json.total.lines.pct
          echo "==> Coverage total de líneas: ${pct}%"
        }
      }
    }
  }

  post {
    always {
      // Archiva la carpeta de cobertura para histórico
      archiveArtifacts artifacts: 'coverage/**', fingerprint: true
    }
  }
}
